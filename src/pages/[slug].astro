---
import { getCollection } from "astro:content";
import Layout from "@layouts/Layout.astro";
import RelatedPostsCard from "@components/RelatedPostsCard.astro";
import FormattedDate from "@components/FormattedDate.astro";
import OptimizedCover from "@components/OptimizedPicture.astro";
import { extractFaqs } from "../utils/extractFaqs";

// Definisi tipe untuk itemList dan FAQ agar konsisten
interface Item {
  title: string;
  url: string;
}

interface Faq {
  question: string;
  answer: string;
}

export async function getStaticPaths() {
  const posts = await getCollection("posts");

  return posts.map((post, index) => {
    const slug = post.slug || post.id;
    const prev = posts[index - 1] || null;
    const next = posts[index + 1] || null;

    return {
      params: { slug },
      props: {
        ...post,
        slug,
        prevPost: prev ? { title: prev.data.title, slug: prev.slug || prev.id } : null,
        nextPost: next ? { title: next.data.title, slug: next.slug || next.id } : null,
      },
    };
  });
}

const post = Astro.props;
const { Content } = await post.render();
const safeWordCount =
  typeof (post.data as any).wordCount === "number"
    ? (post.data as any).wordCount
    : 500;

const isDev = import.meta.env.DEV;
const base = isDev ? "http://localhost:4321" : Astro.site?.href ?? "https://wildgreen.blog";
const resolve = (path: string): string => new URL(path, base).href;

// Ambil body raw dari markdown, lalu ekstrak FAQ
const html = post.body;
const faqs: Faq[] = extractFaqs(html);
---

<Layout
  title={post.data.title}
  description={post.data.description}
  type="post"
  url={Astro.url.href}
  featuredImage={post.data.cover}
  datePublished={new Date(post.data.pubDate).toISOString()}
  dateModified={new Date().toISOString()}
  wordCount={safeWordCount}
  articleBody={post.data.description}
  itemList={[
    { title: "Home", url: base },
    {
      title: Array.isArray(post.data.category)
        ? post.data.category[0] || "Blog"
        : post.data.category || "Blog",
      url: resolve("/blog/")
    },
    { title: post.data.title, url: Astro.url.href }
  ]}
  faqs={faqs}
>

  <main>
    <nav class="text-sm mt-4 mb-2 text-gray-600 dark:text-gray-400">
  <a href="/" class="hover:underline">Home</a>
  {" > "}

  {post.data.category && (
    <a
      href={`/category/${
        Array.isArray(post.data.category)
          ? post.data.category[0]
          : post.data.category
      }/`}
      class="hover:underline text-gray-800 dark:text-gray-200"
    >
      {
        Array.isArray(post.data.category)
          ? post.data.category[0]
          : post.data.category
      }
    </a>
  )}

  {" > "}
  <span class="text-gray-800 dark:text-gray-200">
    {post.data.title}
  </span>
</nav>


    <article class="prose prose-lg max-w-none mx-auto dark:prose-invert pt-12 pb-8">
      <div class="prose-h1 text-left">
        <h1>
          <a
            href={Astro.url.href}
            aria-label={`Permalink to: ${post.data.title}`}
            class="text-blue-600 hover:underline focus:outline-none focus:ring-2 focus:ring-blue-400"
          >
            {post.data.title}
          </a>
        </h1>
        {/* === Date + Author === */}
        <p class="mt-2 text-sm text-gray-500 dark:text-gray-400">
          <FormattedDate date={post.data.pubDate} /> Â· {post.data.author}
        </p>
      </div>

      {post.data.cover && post.data.coverAlt && (
        <OptimizedCover src={post.data.cover} alt={post.data.coverAlt} />
      )}

      <div>
        <Content />
      </div>

      {/* === Tags (text only) === */}
      {post.data.tags && (
        <div class="mt-6 flex flex-wrap gap-2">
          {post.data.tags.map((tag) => (
            <span
              class="inline-block rounded-full bg-neutral-200 px-3 py-1 text-sm dark:bg-neutral-600"
            >
              #{tag}
            </span>
          ))}
        </div>
      )}
    </article>

    {/* === Prev/Next Navigation === */}
    <div class="max-w-4xl mx-auto px-3 sm:px-6 lg:px-8">
      <div class="mt-6 mb-12 grid gap-4 md:grid-cols-2">
        {post.prevPost && (
          <a
            href={resolve(`/${post.prevPost.slug}/`)}
            class="flex flex-col px-6 py-6 border rounded-lg bg-gray-50 hover:bg-gray-100 dark:bg-black/30 dark:hover:bg-black/50 transition"
            aria-label={`Go to: ${post.prevPost.title}`}
          >
            <h4 class="text-lg font-semibold text-gray-800 dark:text-white">
              {post.prevPost.title}
            </h4>
          </a>
        )}

        {post.nextPost && (
          <a
            href={resolve(`/${post.nextPost.slug}/`)}
            class="flex flex-col px-6 py-6 border rounded-lg bg-gray-50 hover:bg-gray-100 dark:bg-black/30 dark:hover:bg-black/50 transition"
            aria-label={`Go to: ${post.nextPost.title}`}
          >
            <h4 class="text-lg font-semibold text-gray-800 dark:text-white">
              {post.nextPost.title}
            </h4>
          </a>
        )}
      </div>
    </div>

    {/* Related posts by category */}
    {post.data.category && (
      <div class="mt-8">
        <RelatedPostsCard
          currentCategory={post.data.category}
          currentSlug={post.slug}
        />
      </div>
    )}
  </main>
</Layout>
